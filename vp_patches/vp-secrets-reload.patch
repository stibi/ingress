From 733403b35f9a6fa9fecb2980a6ed206e66b34b0e Mon Sep 17 00:00:00 2001
From: Martin Stiborsky <martin.stiborsky@gmail.com>
Date: Wed, 13 Sep 2017 22:04:33 +0200
Subject: [PATCH] my patch with forced secrets update and nginx reload

---
 core/pkg/ingress/controller/backend_ssl.go |  2 --
 core/pkg/ingress/controller/controller.go  | 10 ++++++++++
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/core/pkg/ingress/controller/backend_ssl.go b/core/pkg/ingress/controller/backend_ssl.go
index 69ef6b94..05f83df9 100644
--- a/core/pkg/ingress/controller/backend_ssl.go
+++ b/core/pkg/ingress/controller/backend_ssl.go
@@ -24,11 +24,9 @@ import (
 	"github.com/golang/glog"
 
 	api "k8s.io/client-go/pkg/api/v1"
-	extensions "k8s.io/client-go/pkg/apis/extensions/v1beta1"
 	"k8s.io/client-go/tools/cache"
 
 	"k8s.io/ingress/core/pkg/ingress"
-	"k8s.io/ingress/core/pkg/ingress/annotations/parser"
 	"k8s.io/ingress/core/pkg/net/ssl"
 )
 
diff --git a/core/pkg/ingress/controller/controller.go b/core/pkg/ingress/controller/controller.go
index 6b3ae40a..fbd1c0e7 100644
--- a/core/pkg/ingress/controller/controller.go
+++ b/core/pkg/ingress/controller/controller.go
@@ -208,17 +208,27 @@ func newIngressController(config *Configuration) *GenericController {
 	}
 
 	secrEventHandler := cache.ResourceEventHandlerFuncs{
+		AddFunc: func(obj interface{}) {
+			sec := obj.(*api.Secret)
+			key := fmt.Sprintf("%v/%v", sec.Namespace, sec.Name)
+			ic.syncSecret(key)
+			ic.forceReload = true
+			ic.syncQueue.Enqueue(obj)
+		},
 		UpdateFunc: func(old, cur interface{}) {
 			if !reflect.DeepEqual(old, cur) {
 				sec := cur.(*api.Secret)
 				key := fmt.Sprintf("%v/%v", sec.Namespace, sec.Name)
 				ic.syncSecret(key)
+				ic.forceReload = true
+				ic.syncQueue.Enqueue(cur)
 			}
 		},
 		DeleteFunc: func(obj interface{}) {
 			sec := obj.(*api.Secret)
 			key := fmt.Sprintf("%v/%v", sec.Namespace, sec.Name)
 			ic.sslCertTracker.DeleteAll(key)
+			ic.syncSecret(key)
 		},
 	}
 
-- 
2.14.1

